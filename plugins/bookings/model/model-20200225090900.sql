/*
ts:2020-02-25 09:09:00
*/

ALTER TABLE `plugin_ib_educate_bookings` MODIFY COLUMN `payment_method`  ENUM('cc','sms','invoice','cash');

UPDATE `plugin_reports_reports` SET `sql`='select \r\n		courses.title as `Course`,\r\n		schedules.`name` as `Schedule`,\r\n		categories.category as `Category`,\r\n		subjects.`name` as `Subject`,\r\n		if(orgs.id is null, concat_ws(\' \', payers.first_name, payers.last_name), concat_ws(\' \', orgs.first_name, orgs.last_name)) as `Organization`,\r\n		date_format(schedules.start_date, \'%d-%M-%Y\') as `Starts`,\r\n		bookings.payment_method as `Payment Method`,\r\n		sum(outstandings.total) as `Total`\r\n	from plugin_ib_educate_bookings bookings\r\n		inner join plugin_ib_educate_booking_items items on bookings.booking_id = items.booking_id\r\n		inner join plugin_courses_schedules_events timeslots on items.period_id = timeslots.id\r\n		inner join plugin_courses_schedules schedules on timeslots.schedule_id = schedules.id\r\n		inner join plugin_courses_courses courses on schedules.course_id = courses.id\r\n		left join plugin_courses_categories categories on courses.category_id = categories.id\r\n		left join plugin_courses_subjects subjects on schedules.subject_id = subjects.id\r\n		inner join plugin_contacts3_contacts contacts on bookings.contact_id = contacts.id\r\n		inner join \r\n			(select \r\n					transactions.booking_id,\r\n          transactions.contact_id,\r\n					transactions.id as transaction_id,\r\n					transactions.total as total,\r\n					sum(payments.amount) as paid,\r\n					transactions.total - ifnull(sum(payments.amount), 0) as outstanding\r\n				from plugin_bookings_transactions transactions\r\n					inner join plugin_bookings_transactions_types ttypes on transactions.type = ttypes.id\r\n					left join plugin_bookings_transactions_payments payments on transactions.id = payments.transaction_id and payments.deleted = 0 and payments.`status` = 2\r\n				where transactions.deleted = 0 and ttypes.credit = 1\r\n				group by transactions.id\r\n		) outstandings on bookings.booking_id = outstandings.booking_id\r\n		left join plugin_contacts3_contacts payers on outstandings.contact_id = payers.id\r\n    left join plugin_contacts3_relations rels on payers.id = rels.child_id\r\n		left join plugin_contacts3_contacts orgs on rels.parent_id = orgs.id\r\n\r\n	where bookings.`delete` = 0 and items.`delete` = 0 and timeslots.`delete` = 0\r\n		and (schedules.start_date < date_add(\'{!Before!}\', interval 1 day) or \'\' = \'{!Before!}\') and (schedules.start_date >= \'{!After!}\' or \'\' = \'{!After!}\') and (course_id = \'{!Course!}\' or \'\' = \'{!Course!}\')\r\n    and (courses.category_id = \'{!Category!}\' or \'\' = \'{!Category!}\')\r\n	group by schedules.id, `Organization`, `Payment Method`' WHERE (`name`='Deferred Revenue');
