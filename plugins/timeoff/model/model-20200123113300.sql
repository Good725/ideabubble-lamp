/*
ts:2020-01-23 11:33:00
*/

INSERT INTO `plugin_reports_reports`
  (`name`, `sql`, `publish`, `delete`, `action_button_label`, `action_button`, `action_event`, `custom_report_rules`, `php_post_filter`)
  VALUES
  (
    'Timeoff Bulk Update',
    'select \r\n		r.id, \r\n		concat_ws(\' \', staffs.first_name, staffs.last_name) as staff, r.staff_id, \r\n		r.duration, \r\n		date_format(r.period_start_date, \'%d/%m/%Y\') as start_date, date_format(r.period_end_date, \'%d/%m/%Y\') as end_date, \r\n		date_format(r.period_start_date, \'%H:%i\') as start_time, date_format(r.period_end_date, \'%H:%i\') as end_time, \r\n		r.created_at, \r\n    r.`status`, r.type\r\n		from plugin_timeoff_requests r\r\n		left join plugin_contacts3_contacts staffs on r.staff_id = staffs.id\r\n		left join plugin_contacts3_contacts departments on r.department_id = departments.id\r\n        where (r.period_start_date >= \'{!After!}\' or \'\' = \'{!After!}\') and (r.period_start_date >= \'{!Before!}\' or \'\' = \'{!Before!}\')\r\n	order by r.period_start_date',
    '1',
    '0',
    'Update Requests',
    '1',
    'var $tr = $(\"#report_table tbody tr\");\r\nvar data = {};\r\n$tr.each(function(){\r\n	$(this).find(\"input,select\").each(function(){\r\n		data[this.name] = this.value;\r\n	});\r\n});\r\n\r\n$.post(\r\n	\"/api/timeoff/bulk_update\",\r\n	data,\r\n	function (response){\r\n	alert(\"Updated\");}\r\n);',
    '$(\"#report_table tbody .datepicker\").datetimepicker({format: \'d/m/Y\', timepicker: false});\r\n$(\"#report_table tbody .timepicker\").datetimepicker({format: \'H:i\', datepicker:false});',
    '$request_stats = array(\r\n	\'\' => __(\'Please select\'),\r\n	\'annual\'        => __(\'Annual\'),\r\n	\'bereavement\'   => __(\'Bereavement\'),\r\n	\'force majeure\' => __(\'Force majeure\'),\r\n	\'sick\'          => __(\'Sick\'),\r\n	\'lieu\'          => __(\'Time in lieu\'),\r\n	\'other\'         => __(\'Other\')\r\n);\r\nforeach ($data as $i => $row) {\r\n	if ($row[\'start_date\'] != $row[\'end_date\']) {\r\n		$row[\'start_time\'] = $row[\'end_time\'] = \'\';\r\n	}\r\n	$row[\'start_date\'] = \'<input class=\"form-control datepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_date]\" value=\"\' . $row[\'start_date\'] . \'\" />\';\r\n	$row[\'end_date\'] = \'<input class=\"form-control datepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_date]\" value=\"\' . $row[\'end_date\'] . \'\" />\';\r\n	$row[\'start_time\'] = \'<input class=\"form-control timepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_time]\" value=\"\' . $row[\'start_time\'] . \'\" />\';\r\n	$row[\'end_time\'] = \'<input class=\"form-control timepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_time]\" value=\"\' . $row[\'end_time\'] . \'\" />\';\r\n	$row[\'type\'] = \'<select class=\"form-control type\" name=\"request[\' . $row[\'id\'] . \'][type]\">\' . html::optionsFromArray($request_stats, $row[\'type\']) . \'</select><input type=\"hidden\" name=\"request[\' . $row[\'id\'] . \'][staff_id]\" value=\"\' . $row[\'staff_id\'] .\'\" />\';\r\n	$data[$i] = $row;\r\n}'
  );
INSERT INTO `plugin_reports_parameters` (`report_id`, `type`, `name`) VALUES ((select id from plugin_reports_reports where `name`='Timeoff Bulk Update'), 'date', 'After');
INSERT INTO `plugin_reports_parameters` (`report_id`, `type`, `name`) VALUES ((select id from plugin_reports_reports where name='Timeoff Bulk Update'), 'date', 'Before');

UPDATE `plugin_reports_reports`
  SET
    `php_post_filter`='$pc = new Ideabubble\\Timeoff\\PeriodCalculator();\r\n\r\n$request_stats = array(\r\n	\'\' => __(\'Please select\'),\r\n	\'annual\'        => __(\'Annual\'),\r\n	\'bereavement\'   => __(\'Bereavement\'),\r\n	\'force majeure\' => __(\'Force majeure\'),\r\n	\'sick\'          => __(\'Sick\'),\r\n	\'lieu\'          => __(\'Time in lieu\'),\r\n	\'other\'         => __(\'Other\')\r\n);\r\nforeach ($data as $i => $row) {\r\n	\r\n	if ($row[\'start_date\'] != $row[\'end_date\']) {\r\n		$row[\'start_time\'] = $row[\'end_time\'] = \'\';\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']), date(\'Y-m-d\', strtotime(date::dmy_to_ymd($row[\'end_date\']) . \" +1 day\")), $row[\'staff_id\']);\r\n	} else {\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']) . \' \' . $row[\'start_time\'], date::dmy_to_ymd($row[\'end_date\']) . \' \' . $row[\'end_time\'], $row[\'staff_id\']);\r\n	}\r\n	$row[\'start_date\'] = \'<input class=\"form-control datepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_date]\" value=\"\' . $row[\'start_date\'] . \'\" />\';\r\n	$row[\'end_date\'] = \'<input class=\"form-control datepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_date]\" value=\"\' . $row[\'end_date\'] . \'\" />\';\r\n	$row[\'start_time\'] = \'<input class=\"form-control timepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_time]\" value=\"\' . $row[\'start_time\'] . \'\" />\';\r\n	$row[\'end_time\'] = \'<input class=\"form-control timepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_time]\" value=\"\' . $row[\'end_time\'] . \'\" />\';\r\n	$row[\'type\'] = \'<select class=\"form-control type\" name=\"request[\' . $row[\'id\'] . \'][type]\">\' . html::optionsFromArray($request_stats, $row[\'type\']) . \'</select><input type=\"hidden\" name=\"request[\' . $row[\'id\'] . \'][staff_id]\" value=\"\' . $row[\'staff_id\'] .\'\" />\';\r\n	//$row[\'duration_calc\'] = $duration;\r\n	if ($duration != $row[\'duration\']) {\r\n		$row[\'duration\'] .= \' vs. <b style=\"color:red;\">\' . $duration . \'</b>\';\r\n	}\r\n	$data[$i] = $row;\r\n}\r\n'
  WHERE (name='Timeoff Bulk Update');

UPDATE `plugin_reports_reports`
  SET
    `sql`='select \r\n		r.id, r.department_id, \r\n		concat_ws(\' \', staffs.first_name, staffs.last_name) as staff, r.staff_id, \r\n		r.duration, \r\n		date_format(r.period_start_date, \'%d/%m/%Y\') as start_date, date_format(r.period_end_date, \'%d/%m/%Y\') as end_date, \r\n		date_format(r.period_start_date, \'%H:%i\') as start_time, date_format(r.period_end_date, \'%H:%i\') as end_time, \r\n		r.created_at, \r\n    r.`status`, r.type\r\n		from plugin_timeoff_requests r\r\n		left join plugin_contacts3_contacts staffs on r.staff_id = staffs.id\r\n		left join plugin_contacts3_contacts departments on r.department_id = departments.id\r\n        where (r.period_start_date >= \'{!After!}\' or \'\' = \'{!After!}\') and (r.period_start_date < date_add(\'{!Before!}\', interval 1 day) or \'\' = \'{!Before!}\')\r\n	order by r.period_start_date',
    `action_event`='$(\"#report_table\").dataTable().fnDestroy();\r\nvar $tr = $(\"#report_table tbody tr\");\r\nvar data = {};\r\n$tr.each(function(){\r\n	$(this).find(\"input,select\").each(function(){\r\n		data[this.name] = this.value;\r\n	});\r\n});\r\n\r\n$.post(\r\n	\"/api/timeoff/bulk_update\",\r\n	data,\r\n	function (response){\r\n	alert(\"Updated\");}\r\n);',
    `php_post_filter`='$pc = new Ideabubble\\Timeoff\\PeriodCalculator();\r\n\r\n$request_stats = array(\r\n	\'\' => __(\'Please select\'),\r\n	\'annual\'        => __(\'Annual\'),\r\n	\'bereavement\'   => __(\'Bereavement\'),\r\n	\'force majeure\' => __(\'Force majeure\'),\r\n	\'sick\'          => __(\'Sick\'),\r\n	\'lieu\'          => __(\'Time in lieu\'),\r\n	\'other\'         => __(\'Other\')\r\n);\r\nforeach ($data as $i => $row) {\r\n	\r\n	if ($row[\'start_date\'] != $row[\'end_date\']) {\r\n		$row[\'start_time\'] = $row[\'end_time\'] = \'\';\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']), date(\'Y-m-d\', strtotime(date::dmy_to_ymd($row[\'end_date\']) . \" +1 day\")), $row[\'department_id\']);\r\n	} else {\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']) . \' \' . $row[\'start_time\'], date::dmy_to_ymd($row[\'end_date\']) . \' \' . $row[\'end_time\'], $row[\'department_id\']);\r\n	}\r\n  unset($row[\'department_id\']);\r\n	$row[\'start_date\'] = \'<input class=\"form-control datepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_date]\" value=\"\' . $row[\'start_date\'] . \'\" />\';\r\n	$row[\'end_date\'] = \'<input class=\"form-control datepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_date]\" value=\"\' . $row[\'end_date\'] . \'\" />\';\r\n	$row[\'start_time\'] = \'<input class=\"form-control timepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_time]\" value=\"\' . $row[\'start_time\'] . \'\" />\';\r\n	$row[\'end_time\'] = \'<input class=\"form-control timepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_time]\" value=\"\' . $row[\'end_time\'] . \'\" />\';\r\n	$row[\'type\'] = \'<select class=\"form-control type\" name=\"request[\' . $row[\'id\'] . \'][type]\">\' . html::optionsFromArray($request_stats, $row[\'type\']) . \'</select><input type=\"hidden\" name=\"request[\' . $row[\'id\'] . \'][staff_id]\" value=\"\' . $row[\'staff_id\'] .\'\" />\';\r\n	//$row[\'duration_calc\'] = $duration;\r\n	if ($duration != $row[\'duration\']) {\r\n		$row[\'duration\'] .= \' vs. <b style=\"color:red;\">\' . $duration . \'</b>\';\r\n	}\r\n	$data[$i] = $row;\r\n}\r\n'
  WHERE `name`='Timeoff Bulk Update';

INSERT INTO `plugin_reports_parameters` (`report_id`, `type`, `name`, `value`) VALUES ((select id from plugin_reports_reports where `name`='Timeoff Bulk Update'), 'custom', 'Staff', "select distinct r.staff_id, concat_ws(' ', c.first_name, c.last_name) as staff from plugin_timeoff_requests r inner join plugin_contacts3_contacts c on r.staff_id = c.id order by `staff`");
INSERT INTO `plugin_reports_parameters` (`report_id`, `type`, `name`, `value`) VALUES ((select id from plugin_reports_reports where `name`='Timeoff Bulk Update'), 'dropdown', 'Type', "; ;ANNUAL;FORCE MAJEURE;SICK;OTHER");
INSERT INTO `plugin_reports_parameters` (`report_id`, `type`, `name`, `value`) VALUES ((select id from plugin_reports_reports where `name`='Timeoff Bulk Update'), 'dropdown', 'Display', "ALL;ERRORS ONLY");

UPDATE `plugin_reports_reports` SET `sql`='select \r\n		r.id, r.department_id, \r\n		concat_ws(\' \', staffs.first_name, staffs.last_name) as staff, r.staff_id, \r\n		r.duration, \r\n		date_format(r.period_start_date, \'%d/%m/%Y\') as start_date, date_format(r.period_end_date, \'%d/%m/%Y\') as end_date, \r\n		date_format(r.period_start_date, \'%H:%i\') as start_time, date_format(r.period_end_date, \'%H:%i\') as end_time, \r\n		r.created_at, \r\n    r.`status`, r.type\r\n		from plugin_timeoff_requests r\r\n		left join plugin_contacts3_contacts staffs on r.staff_id = staffs.id\r\n		left join plugin_contacts3_contacts departments on r.department_id = departments.id\r\n        where (r.period_start_date >= \'{!After!}\' or \'\' = \'{!After!}\') and (r.period_start_date < date_add(\'{!Before!}\', interval 1 day) or \'\' = \'{!Before!}\') and (r.staff_id = \'{!Staff!}\' or \'\'=\'{!Staff!}\') and (r.type = \'{!Type!}\' or \'\'=\'{!Type!}\')\r\n	order by r.period_start_date\r\n', `action_event`='$(\"#report_table\").dataTable().fnDestroy();\r\nvar $tr = $(\"#report_table tbody tr\");\r\nvar data = {};\r\n$tr.each(function(){\r\n	if ($(this).find(\".row_check\").prop(\"checked\")) {\r\n		$(this).find(\"input,select\").each(function(){\r\n			if (this.name){\r\n				data[this.name] = this.value;\r\n			}\r\n		});\r\n	}\r\n});\r\n\r\n$.post(\r\n	\"/api/timeoff/bulk_update\",\r\n	data,\r\n	function (response){\r\n	alert(\"Updated\");}\r\n);\r\n\r\n', `custom_report_rules`='$(\"#report_table tbody .datepicker\").datetimepicker({format: \'d/m/Y\', timepicker: false});\r\n$(\"#report_table tbody .timepicker\").datetimepicker({format: \'H:i\', datepicker:false, step: 5});\r\n', `php_post_filter`='$pc = new Ideabubble\\Timeoff\\PeriodCalculator();\r\n\r\n$request_stats = array(\r\n	\'\' => __(\'Please select\'),\r\n	\'annual\'        => __(\'Annual\'),\r\n	\'bereavement\'   => __(\'Bereavement\'),\r\n	\'force majeure\' => __(\'Force majeure\'),\r\n	\'sick\'          => __(\'Sick\'),\r\n	\'lieu\'          => __(\'Time in lieu\'),\r\n	\'other\'         => __(\'Other\')\r\n);\r\n$display_all = $this->get_parameter(\"Display\") == \"ALL\";\r\nforeach ($data as $i => $row) {\r\n	\r\n	if ($row[\'start_date\'] != $row[\'end_date\']) {\r\n		$row[\'start_time\'] = $row[\'end_time\'] = \'\';\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']), date(\'Y-m-d\', strtotime(date::dmy_to_ymd($row[\'end_date\']) . \" +1 day\")), $row[\'department_id\']);\r\n    \r\n	} else {\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']) . \' \' . $row[\'start_time\'], date::dmy_to_ymd($row[\'end_date\']) . \' \' . $row[\'end_time\'], $row[\'department_id\']);\r\n	}\r\n  unset($row[\'department_id\']);\r\n	$row[\'start_date\'] = \'<input class=\"form-control datepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_date]\" value=\"\' . $row[\'start_date\'] . \'\" />\';\r\n	$row[\'end_date\'] = \'<input class=\"form-control datepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_date]\" value=\"\' . $row[\'end_date\'] . \'\" />\';\r\n	$row[\'start_time\'] = \'<input class=\"form-control timepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_time]\" value=\"\' . $row[\'start_time\'] . \'\" />\';\r\n	$row[\'end_time\'] = \'<input class=\"form-control timepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_time]\" value=\"\' . $row[\'end_time\'] . \'\" />\';\r\n	$row[\'type\'] = \'<select class=\"form-control type\" name=\"request[\' . $row[\'id\'] . \'][type]\">\' . html::optionsFromArray($request_stats, $row[\'type\']) . \'</select><input type=\"hidden\" name=\"request[\' . $row[\'id\'] . \'][staff_id]\" value=\"\' . $row[\'staff_id\'] .\'\" />\';\r\n	$row[\'duration_calculated\'] = $pc->format_minutes($duration);\r\n   $wrong = false;\r\n	 if ($duration != $row[\'duration\']) {\r\n     $wrong = true;\r\n		 $row[\'duration_calculated\'] = \'<b style=\"color:red;\">\' . $row[\'duration_calculated\'] . \'</b>\';\r\n	}\r\n  $row[\'duration\'] = $pc->format_minutes($row[\'duration\']);\r\n  \r\n	$data[$i] = array(\r\n			\'id\' => $row[\'id\'],\r\n			\'staff\' => $row[\'staff\'],\r\n			\'staff_id\' => $row[\'staff_id\'],\r\n			\'duration\' => $row[\'duration\'],\r\n			\'duration_calculated\' => $row[\'duration_calculated\'],\r\n			\'start_date\' => $row[\'start_date\'],\r\n			\'end_date\' => $row[\'end_date\'],\r\n			\'start_time\' => $row[\'start_time\'],\r\n			\'end_time\' => $row[\'end_time\'],\r\n			\'type\' => $row[\'type\'],\r\n  );\r\n  if (!$display_all && !$wrong) {\r\n    unset($data[$i]);\r\n  }\r\n}\r\n\r\n' WHERE (`name`='Timeoff Bulk Update');

UPDATE `plugin_reports_reports`
  SET
    `checkbox_column`='1',
    `php_post_filter`='$pc = new Ideabubble\\Timeoff\\PeriodCalculator();\r\n\r\n$request_stats = array(\r\n	\'\' => __(\'Please select\'),\r\n	\'annual\'        => __(\'Annual\'),\r\n	\'bereavement\'   => __(\'Bereavement\'),\r\n	\'force majeure\' => __(\'Force majeure\'),\r\n	\'sick\'          => __(\'Sick\'),\r\n	\'lieu\'          => __(\'Time in lieu\'),\r\n	\'other\'         => __(\'Other\')\r\n);\r\n$display_all = $this->get_parameter(\"Display\") == \"ALL\";\r\nforeach ($data as $i => $row) {\r\n	\r\n	if ($row[\'start_date\'] != $row[\'end_date\']) {\r\n		$row[\'start_time\'] = $row[\'end_time\'] = \'\';\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']), date(\'Y-m-d\', strtotime(date::dmy_to_ymd($row[\'end_date\']) . \" +1 day\")), $row[\'department_id\']);\r\n    \r\n	} else {\r\n		$duration = $pc->calculate(date::dmy_to_ymd($row[\'start_date\']) . \' \' . $row[\'start_time\'], date::dmy_to_ymd($row[\'end_date\']) . \' \' . $row[\'end_time\'], $row[\'department_id\']);\r\n	}\r\n  unset($row[\'department_id\']);\r\n	$row[\'start_date\'] = \'<input class=\"form-control datepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_date]\" value=\"\' . $row[\'start_date\'] . \'\" />\';\r\n	$row[\'end_date\'] = \'<input class=\"form-control datepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_date]\" value=\"\' . $row[\'end_date\'] . \'\" />\';\r\n	$row[\'start_time\'] = \'<input class=\"form-control timepicker start\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][start_time]\" value=\"\' . $row[\'start_time\'] . \'\" />\';\r\n	$row[\'end_time\'] = \'<input class=\"form-control timepicker end\" type=\"text\" name=\"request[\' . $row[\'id\'] . \'][end_time]\" value=\"\' . $row[\'end_time\'] . \'\" />\';\r\n	$row[\'type\'] = \'<select class=\"form-control type\" name=\"request[\' . $row[\'id\'] . \'][type]\">\' . html::optionsFromArray($request_stats, $row[\'type\']) . \'</select><input type=\"hidden\" name=\"request[\' . $row[\'id\'] . \'][staff_id]\" value=\"\' . $row[\'staff_id\'] .\'\" />\';\r\n	$row[\'duration_calculated\'] = $pc->format_minutes($duration);\r\n   $wrong = false;\r\n	 if ($duration != $row[\'duration\']) {\r\n     $wrong = true;\r\n		 $row[\'duration_calculated\'] = \'<b style=\"color:red;\">\' . $row[\'duration_calculated\'] . \'</b>\';\r\n	}\r\n  $row[\'duration\'] = $pc->format_minutes($row[\'duration\']);\r\n  \r\n	$data[$i] = array(\r\n			\'id\' => $row[\'id\'],\r\n			\'staff\' => $row[\'staff\'],\r\n			\'staff_id\' => $row[\'staff_id\'],\r\n			\'duration\' => $row[\'duration\'],\r\n			\'duration_calculated\' => $row[\'duration_calculated\'],\r\n			\'start_date\' => $row[\'start_date\'],\r\n			\'end_date\' => $row[\'end_date\'],\r\n			\'start_time\' => $row[\'start_time\'],\r\n			\'end_time\' => $row[\'end_time\'],\r\n      \'status\' => $row[\'status\'],\r\n			\'type\' => $row[\'type\'],\r\n  );\r\n  if (!$display_all && !$wrong) {\r\n    unset($data[$i]);\r\n  }\r\n}\r\n\r\n$data = array_values($data);\r\n',
    `action_event`='$(\"#report_table\").dataTable().fnDestroy();\r\nvar $tr = $(\"#report_table tbody tr\");\r\nvar data = {};\r\nvar selected_one = false;\r\n$tr.each(function(){\r\n	if ($(this).find(\".row_check\").prop(\"checked\")) {\r\n     selected_one = true;\r\n		$(this).find(\"input,select\").each(function(){\r\n			if (this.name){\r\n				data[this.name] = this.value;\r\n			}\r\n		});\r\n	}\r\n});\r\n\r\nif (selected_one) {\r\n$.post(\r\n	\"/api/timeoff/bulk_update\",\r\n	data,\r\n	function (response){\r\n	alert(\"Updated\");}\r\n);\r\n}\r\n'
    WHERE (`name`='Timeoff Bulk Update');

