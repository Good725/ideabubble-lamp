/*
ts:2017-03-26 22:43:00
*/

UPDATE `plugin_reports_reports` SET `sql`='SELECT \r\n		sq.id, sq.title AS `Question`,  IFNULL(txtstats.txtanswers, GROUP_CONCAT(CONCAT(ao.label, \' => \', IFNULL(cstats.cnt, 0), \' (\', IFNULL(ROUND(100 * cstats.cnt / cstatstotal.total), 0), \'%)\') SEPARATOR \'\\r\\n\')) AS `Answers`, IFNULL(txtstats.cnt, SUM(IFNULL(cstats.cnt, 0))) AS `Total`\r\n	FROM plugin_survey_questions sq\r\n		INNER JOIN plugin_survey_has_questions hq ON hq.question_id = sq.id AND hq.deleted = 0\r\n		INNER JOIN plugin_survey s ON hq.survey_id = s.id\r\n		LEFT JOIN plugin_survey_answers sa ON sq.answer_id = sa.id \r\n		LEFT JOIN plugin_survey_answer_options ao ON sa.id = ao.answer_id AND ao.deleted = 0\r\n		LEFT JOIN \r\n			(\r\n				SELECT sq.id as qid, sa.id as sid, ao.id as aid, count(*) as `cnt`\r\n					FROM plugin_survey_questions sq\r\n						INNER JOIN plugin_survey_answers sa ON sq.answer_id = sa.id \r\n						INNER JOIN plugin_survey_answer_options ao ON sa.id = ao.answer_id \r\n						INNER JOIN plugin_survey_answer_result ar ON ar.question_id = sq.id AND ar.answer_id = ao.id\r\n					GROUP BY sq.id, sa.id, ao.id\r\n					ORDER BY ao.order_id\r\n			) cstats ON sq.id = cstats.qid AND sa.id = cstats.sid AND ao.id = cstats.aid\r\n		LEFT JOIN \r\n			(\r\n				SELECT sq.id as qid, count(*) as `total`\r\n					FROM plugin_survey_questions sq\r\n						INNER JOIN plugin_survey_answers sa ON sq.answer_id = sa.id \r\n						INNER JOIN plugin_survey_answer_options ao ON sa.id = ao.answer_id \r\n						INNER JOIN plugin_survey_answer_result ar ON ar.question_id = sq.id AND ar.answer_id = ao.id\r\n					GROUP BY sq.id\r\n			) cstatstotal ON sq.id = cstatstotal.qid\r\n		LEFT JOIN \r\n			(\r\n				SELECT sq.id as qid, GROUP_CONCAT(ar.textbox_value SEPARATOR \'\\r\\n- - - - -\\r\\n\') as txtanswers, count(*) as `cnt`\r\n					FROM plugin_survey_questions sq\r\n						INNER JOIN plugin_survey_answer_result ar ON ar.question_id = sq.id\r\n					WHERE ar.textbox_value IS NOT NULL\r\n					GROUP BY sq.id\r\n			) txtstats ON sq.id = txtstats.qid\r\n	WHERE s.title =  \"{!survey_title!}\"\r\n	GROUP BY sq.id\r\n	ORDER BY sq.title' WHERE (`id`='17');
